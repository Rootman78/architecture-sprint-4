Выбор и настройка мониторинга в системе

Анализ узлов системы для организации мониторинга:
Перед организацией мониторинга необходимо проанализировать потенциальные проблемы компонентов и их взаимосвязей. Исходя из полученных данных, мы примем решении об организации мониторинга только для необходимых узлов и взаимосвязей. В установке мониторинга всего нет необходимости, так как это потребует привлечение дополнительных сотрудников и отрицательно скажется на производительности системы (мониторинг потребляет ресурсы). 
Так как система находится в одном облаке, можем предположить, что проблем взаимосвязи между компонентами и базами данных нет. Связь через MQ то же не должна доставлять проблем, так как между MES и CRM не проходят болящие объемы данных, только отслеживаются статусы заказов. 
Но проблемы могут возникать при связи внешних систем с внутренними. Считаю что для их отслеживания необходимо установить мониторинг взаимосвязей внешних и внутренних модулей системы.
 Система состоит из трёх приложений: Онлайн-магазин, CRM, MES. 
 На мой взгляд, проблемы с производительностью в Онлайн магазине быть не должно, так как этот модуль только получает заказы и передает в хранилище файлов. Количество клиентов, загружающих онлайн-модели и планируемый их рост не способны обвалить сайт огромным количеством запросов исходя из специфики бизнеса.
Проблем с CRM то же не должно быть, так как она только получает заказы и передает в хранилище файлов. Количество заказов не запредельное, исходя из специфики бизнеса.
Приложение МЕS может вызывать проблемы, так как в нем происчходит расчет стоимости заказа на основе числа полигонов, который может длится до 30 минут на заказ, из за которого может возникать повышенная загрузка приложения, из-за которого оно не успевает своевременно заканчивать расчет. Считаю, что тут необходимо установить мониторинг.

Выбор подхода к мониторингу:
Считаю, что необходимо использовать следующие подходы:
1. Для мониторинга внешних API больше подойдет "Четыре золотых сигнала"
2. Для мониторинга расчета стоимости заказа лучше подходит USE 


Список метрик для отслеживания:

1. Для мониторинга работы внешних API(Четыре золотых сигнала):
Number of requests (RPS) for MES API -  показатель позволит отслеживать "Трафик"
Response time (latency) for MES API - показатель позволяющий отслеживать "Задержку"
Number of HTTP 500 for MES API -  показатель позволяющий отслеживать "Ошибки"
Количество успешных запросов к MES API - показатель позволит отслеживать "Насыщенность"
2. Для мониторинга расчетов стоимости заказов (USE).
CPU % for MES API - показатель позволяет отследить "Утилизацию"
Memory Utilisation for MES API - показатель позволяет отследить "Утилизацию"
Количество не рассчитанных заказов для MES API - показатель позволяет отследить "Насыщенность"
Количество ошибок при расчете заказов для MES API - показатель позволяет отследить "Ошибки"

План действий:
1. Для организации мониторинга мы подключим к компоненту MES API систему сбора данных Prometeus и прописываем в коде метрики описанные в предыдущем пункте.
2. Устанавливаем Grafana для визуализации полученных данных. 
3. Связываем Grafana с Prometeus и получаем результаты по нашим метрикам

Показатели насыщенности:
Для MES API показатели насыщенности "Количество успешных запросов к MES API" позволяет понять как проходит передача данных и на сколько она успешна. В случае если количество успешных запросов стремится к нулю, необходимо, перезагрузить сервис, если не поможет подключить DevOps-инженера для сбора других метрик и анализа данных. В случае ошибки после установки обновлений, откатится к предыдущей версии.
Рекомендуется в дальнейшем в этом месте использовать паттерна Circuit Breaker.

Для мониторинга расчетов:
Для мониторинга показателей насыщенности используется метрика "Количество не рассчитанных заказов для MES API". Определяется как количество заказов загруженных в хранилище через Shop API и CRM API, но по которым не была рассчитана стоимость. В случае, если таких заказов больше чем 2, информировать DevOps-инженера. В будущем, в случае, если таких заказов больше чем 2, необходимо автоматически создавать дополнительные копии сервисов расчетов, работающие в параллель, для скорейшего решения проблем в этом узком месте. Предлагаю для этих целей использовать Kubernatis





Заметки:
Сейчас у «Александрита» есть отдельная CRM для работы с клиентами и MES для производства

MES рассчитывает стоимость производства изделия на своей стороне, приложение онлайн-магазина в расчётах не участвует.

Скорость расчёта зависит от количества полигонов в 3D-модели. Если модель сложная и детализированная, время обработки может достигать 30 минут.

Нагрузка растёт линейно. В среднем каждый месяц «Александрит» получает на 100 заказов больше, чем в предыдущий

Архитектура:

Система состоит из трёх приложений:
Онлайн-магазин — написан на Vue и Java Spring Boot.
CRM — SPA-приложение, фронтэнд написан на Vue, бэкенд — на Java Spring Boot.
MES — SPA-приложение, фронтенд написан на React, бэкенд — на C#.

MES и CRM взаимодействуют друг с другом через RabbitMQ.


 




Сейчас всё уже перенесли в облако. Каждый из инстансов крутится как EC2, базы данных — это Managed services на Yandex Cloud.

 Каждое приложение имеет по одному инстансу.

 Базы данных имеют один инстанс, который работает на запись и на чтение.
 
 Окружений всего три: dev, release и prod.
 
 CI/CD реализован так:
Деплой в dev-окружение осуществляется автоматически после мёрджа пул-реквеста и прохождения юнит-тестов.
В release-окружения версию деплоят вручную.
В продакшн версию тоже деплоят вручную

Как выстроены процессы
Команда выпускает софт двухнедельными спринтами. Есть тестовое окружение, на нём QA-инженер прогоняет E2E-сценарии вручную. Если он обнаруживает баги уровня high или highest, то версию не деплоят на продакшн до их починки. Это часто приводит к значительным задержкам релиза. Раньше задержки не превышали одного месяца, но в последнее время требуется всё больше и больше времени.





Проблемы:

Клиенты жалуются менеджерам по продажам, что они не получили заказ и над их изделием работают уже несколько месяцев, хотя обещали закончить за три недели. 

Проблемы не на стороне производства: производственные мощности позволяют справиться с заказами и могут обеспечить двукратный рост.

Во втором квартале «Александрит» начал принимать заказы от других продавцов ювелирных изделий, чтобы дополнительно увеличить охват. Для этого компания открыла свой API, который MES использует для расчёта стоимости изделия.  Жалоб от клиентов на просроченные заказы стало ещё больше.

Добавились жалобы со стороны пользователей API. Представители компаний ежедневно сообщают, что не получили свои заказы.

Участились жалобы от операторов: когда они заходят на первую страницу MES, система долго прогружается. Операторам важно видеть самые новые заказы, потому что от этого зависит их вознаграждение, — кто взял заказ, тот и получит оплату.



Во всех приложениях есть аутентификация и авторизация. Договоримся, что там проблем нет. 

Резюме по проблемам:

Через месяц после открытия API компания потеряла уже несколько крупных контрактов из-за проблем с заказами. Недовольство клиентов онлайн-магазина (B2C) тоже растёт. 

Команда:

В инженерной команде, кроме вас, работает ещё восемь человек:
Фронтенд — два инженера Vue, один частично знает React.
Бэкенд — два инженера Java, один разработчик на C#.
QA — один инженер по ручному тестированию, хочет заняться автоматизацией и уже делал несколько прототипов.
Тимлид — бывший разработчик на C#.
Продакт-менеджер — общается с бизнесом, отвечает за поддержку приложения.
Один DevOps-инженер.
