# Архитектурное решение по кешированию

## Анализ диаграммы
Проанализировав взаимодействие компонентов MES на диаграмме, вижу следующие варианты использования кеширования:
1. Использовать клиентское кеширование. Он позволит уменьшить время загрузки данных на фронтенд с MES API
2. Использовать серверноре кеширование для того, чтобы максимально быстро получать данные из MES DB

## Мотивация и предполагаемое решение
Как альтернативу кешированию, можно рассмотреть следующие варианты:
1. разделение компонента MES API на 3 компонента - один из них будет заниматься исключительно расчетами, другой работой с операторами, третий взаимодействием с USER API операторами. Нагрузка распределится по разным компонентам, тем самым снизится нагрузка на компонент взаимодействующий с операторами. 
2. Масштабирование MES API при помощи Kubernatis. В зависимости от нагрузки, количество рабочих Pod будет увеличиваться и тем самым повышаем производительность.
3. Использование клиентского и серверного кеширования, описанного в "Анализ диаграммы"

На мой взгляд, использование кеширования позволит наиболее простым способом увеличить производительность компонента MES. Варианты 1 требует значительной доработки системы. Вариант 2 требует усложняет настройку системы и затраты на облачные сервисы

Для клиентского кеширования предполагается использование настройки Cache-Control: no-cache
Если данные о заказах не менялись, система берет данные из кеш, если данные по заказам обновились, то необходимо обращаться к базе для обновления данных. Так как скорость возникновения новых заказов не большая, этот алгоритм позволит ускорить работу.

Для серверного кеширования  предполагаем использование Refresh-ahead
Для нас основными преимуществом данного паттерна являются:
1. Низкая стоимость чтения данных из БД
2. Согласованность записей кеша, к которым часто обращаются пользователи

В нашем случае данные, к которым часто обращаются пользователи, это данные по заказам.  Именно они будут асинхронно обновляться  



Заметки:
Сейчас у «Александрита» есть отдельная CRM для работы с клиентами и MES для производства

MES рассчитывает стоимость производства изделия на своей стороне, приложение онлайн-магазина в расчётах не участвует.

Скорость расчёта зависит от количества полигонов в 3D-модели. Если модель сложная и детализированная, время обработки может достигать 30 минут.

Нагрузка растёт линейно. В среднем каждый месяц «Александрит» получает на 100 заказов больше, чем в предыдущий

Архитектура:

Система состоит из трёх приложений:
Онлайн-магазин — написан на Vue и Java Spring Boot.
CRM — SPA-приложение, фронтэнд написан на Vue, бэкенд — на Java Spring Boot.
MES — SPA-приложение, фронтенд написан на React, бэкенд — на C#.

MES и CRM взаимодействуют друг с другом через RabbitMQ.


 




Сейчас всё уже перенесли в облако. Каждый из инстансов крутится как EC2, базы данных — это Managed services на Yandex Cloud.

 Каждое приложение имеет по одному инстансу.

 Базы данных имеют один инстанс, который работает на запись и на чтение.
 
 Окружений всего три: dev, release и prod.
 
 CI/CD реализован так:
Деплой в dev-окружение осуществляется автоматически после мёрджа пул-реквеста и прохождения юнит-тестов.
В release-окружения версию деплоят вручную.
В продакшн версию тоже деплоят вручную

Как выстроены процессы
Команда выпускает софт двухнедельными спринтами. Есть тестовое окружение, на нём QA-инженер прогоняет E2E-сценарии вручную. Если он обнаруживает баги уровня high или highest, то версию не деплоят на продакшн до их починки. Это часто приводит к значительным задержкам релиза. Раньше задержки не превышали одного месяца, но в последнее время требуется всё больше и больше времени.





Проблемы:

Клиенты жалуются менеджерам по продажам, что они не получили заказ и над их изделием работают уже несколько месяцев, хотя обещали закончить за три недели. 

Проблемы не на стороне производства: производственные мощности позволяют справиться с заказами и могут обеспечить двукратный рост.

Во втором квартале «Александрит» начал принимать заказы от других продавцов ювелирных изделий, чтобы дополнительно увеличить охват. Для этого компания открыла свой API, который MES использует для расчёта стоимости изделия.  Жалоб от клиентов на просроченные заказы стало ещё больше.

Добавились жалобы со стороны пользователей API. Представители компаний ежедневно сообщают, что не получили свои заказы.

Участились жалобы от операторов: когда они заходят на первую страницу MES, система долго прогружается. Операторам важно видеть самые новые заказы, потому что от этого зависит их вознаграждение, — кто взял заказ, тот и получит оплату.



Во всех приложениях есть аутентификация и авторизация. Договоримся, что там проблем нет. 

Резюме по проблемам:

Через месяц после открытия API компания потеряла уже несколько крупных контрактов из-за проблем с заказами. Недовольство клиентов онлайн-магазина (B2C) тоже растёт. 

Команда:

В инженерной команде, кроме вас, работает ещё восемь человек:
Фронтенд — два инженера Vue, один частично знает React.
Бэкенд — два инженера Java, один разработчик на C#.
QA — один инженер по ручному тестированию, хочет заняться автоматизацией и уже делал несколько прототипов.
Тимлид — бывший разработчик на C#.
Продакт-менеджер — общается с бизнесом, отвечает за поддержку приложения.
Один DevOps-инженер.